<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Sorteio Discipulado</title>

<style>
body{
  font-family:Arial;
  background:linear-gradient(to right,#fce4ec,#c21039);
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:2rem;
}
.nome-btn{
  padding:.5rem 1rem;
  margin:.4rem;
  background:#311722;
  color:#fff;
  border:none;
  border-radius:5px;
  cursor:pointer;
}
.nome-btn:disabled{
  background:#ccc;
  text-decoration:line-through;
}
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  justify-content:center;
  align-items:center;
}
.modal-content{
  background:#fff;
  padding:1.5rem;
  border-radius:10px;
  text-align:center;
  width:300px;
}
input,button{
  margin-top:.6rem;
  padding:.5rem;
  width:100%;
}
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- EmailJS (ANTES de usar) -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<script>
emailjs.init("SHl9LDYLbEucrxB3p");
</script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBbh-OdbzXcCUcYAL3zYX4Vhlx1KiYHeZE",
  authDomain: "projetinho-sorteio.firebaseapp.com",
  databaseURL: "https://projetinho-sorteio-default-rtdb.firebaseio.com",
  projectId: "projetinho-sorteio",
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
</script>
</head>

<body>

<h2>Discipulado das Prim√≠cias</h2>
<div id="botoes"></div>

<div class="modal" id="modal">
  <div class="modal-content">
    <div id="modal-msg"></div>
    <input id="email" type="email" placeholder="Digite seu email">
    <button onclick="enviarEmail()">Enviar Email</button>
    <button onclick="fecharModal()">Fechar</button>
  </div>
</div>

<script>
const nomes = ["Tereza","Anne","Gabby","Kak√°","Tati","Vini","Andr√©","Felipe","Isa","Vit√≥ria","Day","Elydlon","Bia"];
let nomeAtual = "";
let nomeSorteadoAtual = "";

async function buscarSorteados(){
  const s = await database.ref("sorteados").get();
  return s.exists()? s.val():{};
}

async function salvar(nome,sorteado){
  await database.ref("sorteados/"+nome).set(sorteado);
}

function abrirModal(msg){
  document.getElementById("modal-msg").innerHTML = msg;
  document.getElementById("modal").style.display="flex";
}

function fecharModal(){
  document.getElementById("modal").style.display="none";
}

async function sortear(nome,btn){
  nomeAtual = nome;
  const dados = await buscarSorteados();
  if(dados[nome]){
    abrirModal(`Voc√™ j√° tirou <b>${dados[nome]}</b>`);
    return;
  }
  const usados = Object.values(dados);
  const possiveis = nomes.filter(n=>n!==nome && !usados.includes(n));
  nomeSorteadoAtual = possiveis[Math.floor(Math.random()*possiveis.length)];
  await salvar(nome,nomeSorteadoAtual);
  btn.disabled=true;
  abrirModal(`Voc√™ tirou <b>${nomeSorteadoAtual}</b><br><small>Digite seu email</small>`);
}

async function criarBotoes(){
  const dados = await buscarSorteados();
  nomes.forEach(n=>{
    const b=document.createElement("button");
    b.textContent=n;
    b.className="nome-btn";
    b.onclick=()=>sortear(n,b);
    if(dados[n]) b.disabled=true;
    document.getElementById("botoes").appendChild(b);
  });
}

function enviarEmail(){
  const email = document.getElementById("email").value;
  if(!email || !nomeSorteadoAtual){
    alert("Email ou sorteio inv√°lido");
    return;
  }

  emailjs.send(
    "service_8uobx3b",
    "template_391sfag",
    {
      to_email: email,
      nome_pessoa: nomeAtual,
      nome_sorteado: nomeSorteadoAtual
    }
  ).then(()=>{
    alert("Email enviado com sucesso üôè");
    fecharModal();
  }).catch(err=>{
    console.error("ERRO EMAILJS:",err);
    alert("Erro ao enviar email");
  });
}

criarBotoes();
</script>

</body>
</html>

